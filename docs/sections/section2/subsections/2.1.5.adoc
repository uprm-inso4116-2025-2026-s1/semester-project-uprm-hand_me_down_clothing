=== *2.1.5 Events, Actions, and Behaviors*

Each domain concept below is explicitly annotated as *Entity*, *Action*, *Event*, or *Behavior*.
Entities provide structure, Actions trigger Events, and Behaviors describe recurring patterns observed in exchanges.
This annotation clarifies the “diverse notions” called out in feedback and keeps domain vs. system concerns separate.

==== Listing and Discovery
*Entity*::  
A **Listing** — *Entity* — represents an item made visible by a seller for reuse or resale. It includes attributes such as title, description, category, condition, and images.

*Associated Actions*::  
- *Action* — Publishing a listing with sufficient information (title, category, photos).  
- *Action* — Editing details (price marker, condition, description).  
- *Action* — Closing a listing once the item is no longer available.

*Events*::  
- **Listing Published** — *Event* — occurs when a seller makes an item visible to the public.  
- **Listing Updated** — *Event* — occurs when a listing’s information has just been modified.  
- **Listing Closed** — *Event* — occurs when the seller marks the listing as reserved or removed.

*Behavior*::  
*Listing Lifecycle* — *Behavior* — the continuous cycle in which sellers create, update, and close listings to maintain an accurate catalog of available items.

===== Aggregate Definition
[cols="^1,^1,3", options="header"]
|===
| Role | Kind | Notes

| Listing | Aggregate Root | Discoverable item and single entry point for changes.
| ConditionRating | Value Object | Integer in `[1..10]`; updated via root method only.
| Review | Child Entity | `{id, reviewer, rating (1–5), comment, createdAt}`; belongs to exactly one Piece. // reviewer (concept), not just an ID
| Reservation | Value Object | *Conceptually associates a Buyer with a Listing*; storage may use an internal identifier (e.g., buyerId) but the domain concept is *Buyer*.
| Images | Collection of Value Objects | ≥ 1 image required when publishing (URI + metadata).
| Status | Value Object | One of: `Active | Reserved | Closed`.
| Seller | Reference (Primitive/VO) | Owner identity outside the aggregate boundary (storage key may be `sellerId`).
| Locale | Reference (Primitive/VO) | Optional area label to aid discovery (e.g., campus/borough).
|===

[NOTE]
====
*Domain Purity:* Read-model/presentation types such as `Page<ListingSummary>` belong to query/view layers.
They must not be part of the *Listing* aggregate itself.
====

===== Invariants
[cols="2,1,1,3", options="header"]
|===
| Invariant | Enforced In | Temp. Violation? | Rationale
| A Listing requires ≥ 1 image at publish time. | Factory / publish step | No | Visual trust for discovery.
| `ConditionRating` ∈ `[1..10]`. | `rateCondition()` | No | Consistent quality scale.
| A `Review` belongs to exactly one Piece. | `submitReview()` | No | Prevents cross-linking reviews.
| Status transitions follow `Active ↔ Reserved → Closed` (no reopen). | Root methods | Yes (within method only) | Coherent lifecycle; history integrity.
| `reserveFor(buyer)` only when status = `Active`. | `reserveFor()` | No | Avoid double holds; associates with *Buyer* (concept), not just a raw ID.
| `close(reason)` only when status ∈ {`Active`,`Reserved`}. | `close()` | No | Forbids illegal re-closing.
| Editing details is blocked when status = `Closed`. | Root guards | No | Preserve record of completed exchanges.
|===

===== Root Operations (Conceptual Surface)
- `publish()` — (if drafts are modeled) make the Listing publicly visible.
- `editDetails(updates)` — update title/description/attributes (forbidden when `Closed`).
- `rateCondition(newRating)` — set/adjust condition in `[1..10]`.
- `reserveFor(buyer)` — `Active → Reserved` (hold while parties coordinate offline).
- `releaseReservation()` — `Reserved → Active`.
- `close(reason)` — `Active/Reserved → Closed` after offline handoff or withdrawal.
- `submitReview(reviewer, rating, comment)` — attach feedback post-close.

===== Repository (Conceptual)
A repository operates at the *aggregate level* (reads may provide projections for lists):
- `findById(ListingId) → Listing?`
- `save(Listing) → void` (persists the whole aggregate and its members)
- Read-model queries *(projections)* for UI lists, e.g.:
  - `findActiveByFilters(filters) → Page<ListingSummary>`
  - `findBySeller(seller) → Page<ListingSummary>`
