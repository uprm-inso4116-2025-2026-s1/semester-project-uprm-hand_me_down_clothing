=== *2.1.6 – Function Signatures*

==== Objective
Define domain-level function signatures that describe how actions are carried out, including inputs,
outputs, and the resulting changes in the domain. These signatures capture the **domain logic only**, not implementation or UI concerns.

==== Description
Domain function signatures specify:

- the **action** being performed,
- the **information required** for that action,
- the **result** of the action,
- the **state changes** that occur in the domain,
- the **events** generated as a consequence (when relevant).

General form:
`FunctionName : Input1 >< Input2 >< … → OutputType`

Each signature includes:
- **Description**  
- **Preconditions**  
- **Postconditions**  
- **Notes**

We introduce two domain services:

- **ListingFactory** – creates `Listing` objects from valid inputs.  
- **ListingRepository** – conceptual collection of all `Listing` instances.

Browsing, searching, retrieval, and update operations **always** operate on these domain repositories.

Additionally, we define the **Filter** value object for structured searching.

==== Filter Value Object

A *Filter* is an immutable value object that captures buyer-defined search constraints.
It does not depend on UI concepts or pagination.

[cols="1,3,2",options="header"]
|===
| Field | Description | Type / Concept

| `category` | Desired item category (optional). | ++Category++
| `size` | Requested size (optional). | ++Size++
| `gender` | Intended gender classification (optional). | ++Gender++
| `minCondition` | Minimal acceptable condition rating (optional). | ++ConditionRating++
| `maxPrice` | Maximum acceptable price (optional). | Money
| `locale` | Preferred exchange locale (optional). | ++Locale++
| `textQuery` | Free-text search for title/description. | String
| `onlyActive` | Defaults to true; restricts results to active listings. | Boolean
|===

A Listing *matches* a Filter iff all present fields are satisfied by the Listing.

==== Function Signatures

---

===== publishListing  
`publishListing : Piece >< Seller >< Locale >< ListingFactory >< ListingRepository → Either[ValidationError, Listing]`

Description::  
Creates a new Listing from a Piece, Seller, and Locale. The ListingFactory produces the Listing, which is then persisted in the ListingRepository.

Preconditions::  
- Seller exists and is active.  
- Piece exists and contains required metadata (title, condition, images).  
- Locale is valid.  

Postconditions::  
- A new Listing is created through the ListingFactory.  
- The ListingRepository contains the new Listing marked as *available*.  
- The resulting Listing is returned.

Notes::  
This action does *not* trigger payment or delivery behavior.

---

===== expressInterest  
`expressInterest : Listing >< Buyer >< InterestRepository → Either[ContactError, InterestExpressed]`

Description::  
A Buyer expresses interest in a Listing.  
This creates an **Interest (entity)** linking Buyer and Listing, and triggers an **InterestExpressed (event)**.

Preconditions::  
- Listing is available.  
- Buyer is authenticated.  

Postconditions::  
- A new Interest entity is stored in the InterestRepository.  
- An InterestExpressed event is returned to record the moment of expression.

Notes::  
Distinguishes **Interest** (entity) from **InterestExpressed** (event), addressing professor feedback.

---

===== rate  
`rate : Piece >< ConditionRating → Piece`

Description::  
Updates a Piece’s condition rating.

Preconditions::  
- Piece exists.  
- ConditionRating is within valid bounds.

Postconditions::  
- Returns the updated Piece.  
- No rating object is separately returned (as per the professor’s correction).

---

===== review  
`review : Seller >< Buyer >< Review >< ReviewRepository → Either[ReviewError, ReviewSubmitted]`

Description::  
Records a review after an offline exchange.

Preconditions::  
- A prior successful exchange exists between Seller and Buyer.  
- Review is valid.

Postconditions::  
- ReviewRepository stores the review.  
- A ReviewSubmitted event is returned.

Notes::  
Listings do not structurally contain Reviews.

---

===== closeListing  
`closeListing : Listing >< Seller >< ListingRepository → Either[ClosedError, Listing]`

Description::  
Seller closes an active Listing after an offline exchange or a voluntary withdrawal.

Preconditions::  
- Seller owns the Listing.  
- Listing is currently active.

Postconditions::  
- Listing state becomes terminal (`sold`, `donated`, or `retracted`).  
- The updated Listing is returned.  
- ListingRepository reflects the state change.

Notes::  
Addresses professor feedback that the Listing must be returned and updated, not just an event produced.

---

===== categorize  
`categorize : Piece >< Category → Piece`

Description::  
Assigns or updates the category of a Piece.

Preconditions::  
- Piece exists.  

Postconditions::  
- Piece with updated category is returned.

---

===== discard  
`discard : Piece → Piece`

Description::  
Marks a Piece as inactive (removed from circulation).

Postconditions::  
- Returns the updated Piece marked as inactive.

---

===== browseAvailableItems  
`browseAvailableItems : ListingRepository → Set<Listing]`

Description::  
Returns the set of Listings currently available.

Preconditions::  
- ListingRepository is defined.

Postconditions::  
- Returns a (possibly empty) set of active Listings.

Notes::  
Pure query operation (CQS compliant).

---

===== findAvailableByFilter  
`findAvailableByFilter : ListingRepository >< Filter → Set<Listing]`

Description::  
Returns available Listings that satisfy the Filter predicate.

Preconditions::  
- ListingRepository is defined.  
- Filter is valid.

Postconditions::  
- Returns all available Listings matching the Filter.

Notes::  
No Page concept leaks into domain. Strictly a pure query.

---

===== findListingById  
`findListingById : ListingRepository >< ListingID → Option[Listing]`

Description::  
Retrieves a Listing by identifier.

---

==== Example Scenario: From Listing to Offline Exchange

1. Seller publishes a listing:  
   `publishListing(Piece, Seller, Locale, ListingFactory, ListingRepository) → Listing`.

2. Buyer browses available items:  
   `browseAvailableItems(ListingRepository) → Set<Listing>`  
   or narrows results using  
   `findAvailableByFilter(ListingRepository, Filter) → Set<Listing>`.

3. Buyer expresses interest:  
   `expressInterest(Listing, Buyer, InterestRepository) → InterestExpressed`.

4. The exchange occurs offline.

5. Seller closes the Listing:  
   `closeListing(Listing, Seller, ListingRepository) → Listing`.

6. Buyer leaves a review:  
   `review(Seller, Buyer, Review, ReviewRepository) → ReviewSubmitted`.
