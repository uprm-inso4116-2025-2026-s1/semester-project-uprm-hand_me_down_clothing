=== 2.1.7 Closure Under Operations

Closure Under Operations ensures that every domain action returns an object of the *same conceptual type* as the entity being transformed. A function that takes a Listing must return a Listing; a function that updates a Piece must return a Piece. This keeps all transformations inside the domain vocabulary and prevents leaking UI objects, storage formats, or event structures into the domain layer.

==== Motivation

Earlier versions of the model returned heterogeneous outputs: some functions returned events, others returned partial data, and several returned structures tied to implementation details. These breaks in closure made it difficult to chain operations and prevented the domain from being expressed as a stable algebra of transformations.

This was corrected by ensuring that all operations return either:

* the updated domain entity, or
* a domain-defined error wrapped around the same entity type.

==== Updated Function Shapes

The following operations now preserve closure and match the function definitions in Section 2.1.6 of the documentation. 

* publishListing : Piece >< Seller >< Locale → Either[ValidationError, Listing]
* closeListing : Listing >< Seller → Either[ClosedError, Listing]
* rate : Piece >< ConditionRating → Piece
* browseAvailableItems : ListingRepository → Set<Listing>
* findAvailableByFilter : ListingRepository >< Filter → Set<Listing]

Listing-related transformations return Listings, and piece-related updates return Pieces.

==== Cross-Team Evidence of Closure

* Authentication operations always return the canonical AuthContextValue shape or an AuthError. 
* Listing and piece operations always return Piece or Listing entities, never DTOs. 
* Location operations always return Location or List<Location>. 

This cross-team consistency ensures that closure is preserved throughout the system.

==== Unified Example of Closure

A typical Listing lifecycle demonstrates closure under operations:

1. A seller publishes an item, returning a Listing.
2. A buyer expresses interest, producing an InterestExpressed event referencing the same Listing.
3. The seller closes the listing, returning the updated Listing.

Events annotate transitions, but the entity remains stable throughout.

==== Canonical Flow Diagram

[source,plaintext]
----
Piece + Seller + Locale
          |
          v
       Listing (available)

Listing + Buyer
          |
          v
   InterestExpressed (event)
          |
          v
       Listing (same structure)

Listing + Seller
          |
          v
       Listing (closed)
----

==== Benefits

Enforcing closure under operations provides:

* predictable chaining of domain functions,
* compatibility with Command–Query Separation,
* composability across repositories and domain collections,
* a stable set of shapes for testing, validation, and requirements traceability.
