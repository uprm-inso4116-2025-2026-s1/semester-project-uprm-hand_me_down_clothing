// --
// Authentication Flows
// --

= Authentication Flows (Supabase)

== Overview
This document describes how password reset and email verification are implemented in the Hand-Me-Down Clothing platform using Supabase Auth.

== Password Reset Workflow
* Users request a password reset from the login page.
* Supabase sends a password reset email with a magic link.
* After clicking the link, users are directed to a form to set a new password.
* Backend logic: see `source_code/app/auth/auth.ts` (`requestPasswordReset`, `updatePassword`).

== Email Verification Workflow
* New users receive a verification email after sign-up.
* Email verification is automatic via Supabase magic links.
* Verification status can be checked with `getUser()` and inspecting `user.email_confirmed_at`.

== Implementation Reference
* See `source_code/app/auth/` for backend functions and UI forms.

== Phone-based 2FA (SMS OTP)

This project supports optional phone-based two-step verification (2FA) using Supabase's SMS OTP flow.

Flows implemented:

* `signInWithPhone(phone)` — sends an OTP to the user's phone (see `source_code/app/auth/auth.ts`).
* `verifyPhoneOtp(phone, token)` — verifies the OTP and marks the phone as verified in user metadata.

UI pages:

* `/auth/phone-signin` — collect phone number and send OTP.
* `/auth/phone-verify` — enter OTP and verify.
* `/auth/phone-2fa-settings` — add phone, send verification, enable/disable 2FA.

Security notes:

* OTPs are short-lived and verified by Supabase; treat verification errors generically to avoid enumeration.
* When phone is verified, the system sets `phone_2fa: 'enabled'` in user metadata.

